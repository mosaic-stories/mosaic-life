# Settings Page & Help Support Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement a comprehensive Settings page with Profile, Appearance, AI Preferences, Usage & Stats, and Account sections, plus a Help & Support dialog with automatic context capture.

**Architecture:** Vertical sidebar Settings page with section-based routing (`/settings/:section`). User preferences stored in database with localStorage cache for fast loading. Support requests sent via backend API to email with context capture.

**Tech Stack:** React + TypeScript + TanStack Query (frontend), FastAPI + SQLAlchemy + Pydantic (backend), PostgreSQL, AWS SES for email.

---

## Phase 1: Backend Foundation

### Task 1: Add User Preferences Column

**Files:**
- Create: `services/core-api/alembic/versions/xxxx_add_user_preferences.py`
- Modify: `services/core-api/app/models/user.py`

**Step 1: Create migration file**

Run:
```bash
cd services/core-api && uv run alembic revision --autogenerate -m "add_user_preferences"
```

Then edit the generated file to ensure it contains:

```python
"""add user preferences

Revision ID: <auto-generated>
Revises: <previous>
Create Date: <auto-generated>

"""

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects.postgresql import JSONB

revision = "<auto-generated>"
down_revision = "<previous>"
branch_labels = None
depends_on = None


def upgrade() -> None:
    op.add_column(
        "users",
        sa.Column(
            "preferences",
            JSONB,
            nullable=False,
            server_default='{}',
        ),
    )
    op.add_column(
        "users",
        sa.Column("bio", sa.String(500), nullable=True),
    )


def downgrade() -> None:
    op.drop_column("users", "bio")
    op.drop_column("users", "preferences")
```

**Step 2: Run migration**

Run: `cd services/core-api && uv run alembic upgrade head`
Expected: Migration applies successfully

**Step 3: Update User model**

Modify `services/core-api/app/models/user.py`:

```python
from sqlalchemy.dialects.postgresql import JSONB

# Add to User class after avatar_url field:
    bio: Mapped[str | None] = mapped_column(String(500), nullable=True)
    preferences: Mapped[dict] = mapped_column(
        JSONB,
        nullable=False,
        default=dict,
        server_default="{}",
    )
```

**Step 4: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 5: Commit**

```bash
git add services/core-api/alembic/versions/ services/core-api/app/models/user.py
git commit -m "feat(db): add user preferences and bio columns"
```

---

### Task 2: Create Support Requests Table

**Files:**
- Create: `services/core-api/alembic/versions/xxxx_add_support_requests.py`
- Create: `services/core-api/app/models/support_request.py`

**Step 1: Create model file**

Create `services/core-api/app/models/support_request.py`:

```python
"""Support request model for user help tickets."""

from datetime import datetime
from enum import Enum
from uuid import UUID, uuid4

from sqlalchemy import DateTime, ForeignKey, String, Text
from sqlalchemy.dialects.postgresql import JSONB, UUID as PG_UUID
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.sql import func

from ..database import Base


class SupportCategory(str, Enum):
    """Category of support request."""

    GENERAL_QUESTION = "general_question"
    BUG_REPORT = "bug_report"
    FEATURE_REQUEST = "feature_request"
    ACCOUNT_ISSUE = "account_issue"
    OTHER = "other"


class SupportStatus(str, Enum):
    """Status of support request."""

    OPEN = "open"
    IN_PROGRESS = "in_progress"
    RESOLVED = "resolved"
    CLOSED = "closed"


class SupportRequest(Base):
    """Support request model for user help tickets."""

    __tablename__ = "support_requests"

    id: Mapped[UUID] = mapped_column(
        PG_UUID(as_uuid=True),
        primary_key=True,
        default=uuid4,
    )
    user_id: Mapped[UUID] = mapped_column(
        PG_UUID(as_uuid=True),
        ForeignKey("users.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    category: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
    )
    subject: Mapped[str] = mapped_column(String(100), nullable=False)
    message: Mapped[str] = mapped_column(Text, nullable=False)
    context: Mapped[dict] = mapped_column(JSONB, nullable=False, default=dict)
    status: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        default=SupportStatus.OPEN.value,
        index=True,
    )
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.current_timestamp(),
        nullable=False,
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.current_timestamp(),
        onupdate=func.current_timestamp(),
        nullable=False,
    )

    # Relationships
    user: Mapped["User"] = relationship("User", back_populates="support_requests")

    def __repr__(self) -> str:
        return f"<SupportRequest(id={self.id}, user_id={self.user_id}, category={self.category})>"
```

**Step 2: Update User model with relationship**

Add to `services/core-api/app/models/user.py`:

```python
# Add import at top
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from .support_request import SupportRequest

# Add relationship to User class:
    support_requests: Mapped[list["SupportRequest"]] = relationship(
        "SupportRequest", back_populates="user", cascade="all, delete-orphan"
    )
```

**Step 3: Create migration**

Run:
```bash
cd services/core-api && uv run alembic revision --autogenerate -m "add_support_requests"
```

**Step 4: Run migration**

Run: `cd services/core-api && uv run alembic upgrade head`
Expected: Migration applies successfully

**Step 5: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 6: Commit**

```bash
git add services/core-api/alembic/versions/ services/core-api/app/models/
git commit -m "feat(db): add support_requests table"
```

---

### Task 3: Create User Sessions Table

**Files:**
- Create: `services/core-api/alembic/versions/xxxx_add_user_sessions.py`
- Create: `services/core-api/app/models/user_session.py`

**Step 1: Create model file**

Create `services/core-api/app/models/user_session.py`:

```python
"""User session model for tracking active sessions."""

from datetime import datetime
from uuid import UUID, uuid4

from sqlalchemy import DateTime, ForeignKey, String
from sqlalchemy.dialects.postgresql import INET, UUID as PG_UUID
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.sql import func

from ..database import Base


class UserSession(Base):
    """User session model for tracking active login sessions."""

    __tablename__ = "user_sessions"

    id: Mapped[UUID] = mapped_column(
        PG_UUID(as_uuid=True),
        primary_key=True,
        default=uuid4,
    )
    user_id: Mapped[UUID] = mapped_column(
        PG_UUID(as_uuid=True),
        ForeignKey("users.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    session_token: Mapped[str] = mapped_column(
        String(255),
        unique=True,
        nullable=False,
        index=True,
    )
    device_info: Mapped[str | None] = mapped_column(String(255), nullable=True)
    ip_address: Mapped[str | None] = mapped_column(INET, nullable=True)
    location: Mapped[str | None] = mapped_column(String(100), nullable=True)
    last_active_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.current_timestamp(),
        nullable=False,
    )
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.current_timestamp(),
        nullable=False,
    )
    revoked_at: Mapped[datetime | None] = mapped_column(
        DateTime(timezone=True),
        nullable=True,
    )

    # Relationships
    user: Mapped["User"] = relationship("User", back_populates="sessions")

    def __repr__(self) -> str:
        return f"<UserSession(id={self.id}, user_id={self.user_id})>"
```

**Step 2: Update User model with relationship**

Add to `services/core-api/app/models/user.py`:

```python
# Add to TYPE_CHECKING block:
    from .user_session import UserSession

# Add relationship to User class:
    sessions: Mapped[list["UserSession"]] = relationship(
        "UserSession", back_populates="user", cascade="all, delete-orphan"
    )
```

**Step 3: Create migration**

Run:
```bash
cd services/core-api && uv run alembic revision --autogenerate -m "add_user_sessions"
```

**Step 4: Run migration**

Run: `cd services/core-api && uv run alembic upgrade head`
Expected: Migration applies successfully

**Step 5: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 6: Commit**

```bash
git add services/core-api/alembic/versions/ services/core-api/app/models/
git commit -m "feat(db): add user_sessions table"
```

---

### Task 4: Create User Preferences Schemas

**Files:**
- Create: `services/core-api/app/schemas/preferences.py`

**Step 1: Create schema file**

Create `services/core-api/app/schemas/preferences.py`:

```python
"""Schemas for user preferences."""

from pydantic import BaseModel, Field


class UserPreferences(BaseModel):
    """User preferences structure."""

    theme: str = Field(default="warm-amber", description="UI theme identifier")
    default_model: str = Field(
        default="claude-sonnet-4.5", description="Default AI model for new chats"
    )
    hidden_personas: list[str] = Field(
        default_factory=list, description="List of hidden agent persona IDs"
    )


class PreferencesUpdateRequest(BaseModel):
    """Request to update user preferences."""

    theme: str | None = Field(None, description="UI theme identifier")
    default_model: str | None = Field(None, description="Default AI model")
    hidden_personas: list[str] | None = Field(None, description="Hidden persona IDs")


class PreferencesResponse(BaseModel):
    """Response containing user preferences."""

    theme: str
    default_model: str
    hidden_personas: list[str]

    model_config = {"from_attributes": True}


class ProfileUpdateRequest(BaseModel):
    """Request to update user profile."""

    name: str | None = Field(None, min_length=1, max_length=100)
    bio: str | None = Field(None, max_length=500)


class ProfileResponse(BaseModel):
    """Response containing user profile."""

    id: str
    email: str
    name: str
    bio: str | None
    avatar_url: str | None
    created_at: str

    model_config = {"from_attributes": True}
```

**Step 2: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 3: Commit**

```bash
git add services/core-api/app/schemas/preferences.py
git commit -m "feat(schemas): add user preferences schemas"
```

---

### Task 5: Create User Stats Schema

**Files:**
- Create: `services/core-api/app/schemas/stats.py`

**Step 1: Create schema file**

Create `services/core-api/app/schemas/stats.py`:

```python
"""Schemas for user statistics."""

from datetime import datetime

from pydantic import BaseModel


class UserStatsResponse(BaseModel):
    """Response containing user statistics."""

    member_since: datetime
    legacies_count: int
    stories_count: int
    media_count: int
    storage_used_bytes: int
    chat_sessions_count: int
    legacy_views_total: int
    collaborators_count: int
```

**Step 2: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 3: Commit**

```bash
git add services/core-api/app/schemas/stats.py
git commit -m "feat(schemas): add user stats schema"
```

---

### Task 6: Create Support Request Schemas

**Files:**
- Create: `services/core-api/app/schemas/support.py`

**Step 1: Create schema file**

Create `services/core-api/app/schemas/support.py`:

```python
"""Schemas for support requests."""

from datetime import datetime
from uuid import UUID

from pydantic import BaseModel, Field


class SupportContext(BaseModel):
    """Context captured with support request."""

    page_url: str
    timestamp: datetime
    user_agent: str
    legacy_id: str | None = None
    session_duration_seconds: int | None = None
    recent_errors: list[str] = Field(default_factory=list)


class SupportRequestCreate(BaseModel):
    """Request to create a support ticket."""

    category: str = Field(
        ...,
        pattern="^(general_question|bug_report|feature_request|account_issue|other)$",
        description="Support request category",
    )
    subject: str = Field(..., min_length=1, max_length=100)
    message: str = Field(..., min_length=1, max_length=2000)
    context: SupportContext


class SupportRequestResponse(BaseModel):
    """Response after creating support request."""

    id: UUID
    category: str
    subject: str
    status: str
    created_at: datetime

    model_config = {"from_attributes": True}
```

**Step 2: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 3: Commit**

```bash
git add services/core-api/app/schemas/support.py
git commit -m "feat(schemas): add support request schemas"
```

---

### Task 7: Create Session Schemas

**Files:**
- Create: `services/core-api/app/schemas/session.py`

**Step 1: Create schema file**

Create `services/core-api/app/schemas/session.py`:

```python
"""Schemas for user sessions."""

from datetime import datetime
from uuid import UUID

from pydantic import BaseModel


class SessionResponse(BaseModel):
    """Response containing session information."""

    id: UUID
    device_info: str | None
    location: str | None
    last_active_at: datetime
    created_at: datetime
    is_current: bool = False

    model_config = {"from_attributes": True}


class SessionListResponse(BaseModel):
    """Response containing list of sessions."""

    sessions: list[SessionResponse]
```

**Step 2: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 3: Commit**

```bash
git add services/core-api/app/schemas/session.py
git commit -m "feat(schemas): add session schemas"
```

---

### Task 8: Create User Settings Service

**Files:**
- Create: `services/core-api/app/services/settings.py`

**Step 1: Create service file**

Create `services/core-api/app/services/settings.py`:

```python
"""Service layer for user settings operations."""

import logging
from uuid import UUID

from sqlalchemy import func, select
from sqlalchemy.ext.asyncio import AsyncSession

from ..models.legacy import Legacy
from ..models.legacy_member import LegacyMember
from ..models.media import Media
from ..models.story import Story
from ..models.user import User
from ..schemas.preferences import (
    PreferencesResponse,
    PreferencesUpdateRequest,
    ProfileResponse,
    ProfileUpdateRequest,
    UserPreferences,
)
from ..schemas.stats import UserStatsResponse

logger = logging.getLogger(__name__)

# Default preferences
DEFAULT_PREFERENCES = UserPreferences()


async def get_user_preferences(db: AsyncSession, user_id: UUID) -> PreferencesResponse:
    """Get user preferences."""
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()

    if not user:
        raise ValueError(f"User {user_id} not found")

    prefs = user.preferences or {}
    defaults = DEFAULT_PREFERENCES.model_dump()

    return PreferencesResponse(
        theme=prefs.get("theme", defaults["theme"]),
        default_model=prefs.get("default_model", defaults["default_model"]),
        hidden_personas=prefs.get("hidden_personas", defaults["hidden_personas"]),
    )


async def update_user_preferences(
    db: AsyncSession, user_id: UUID, data: PreferencesUpdateRequest
) -> PreferencesResponse:
    """Update user preferences."""
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()

    if not user:
        raise ValueError(f"User {user_id} not found")

    # Merge with existing preferences
    current_prefs = user.preferences or {}
    updates = data.model_dump(exclude_none=True)

    for key, value in updates.items():
        current_prefs[key] = value

    user.preferences = current_prefs
    await db.commit()
    await db.refresh(user)

    logger.info(
        "user.preferences.updated",
        extra={"user_id": str(user_id), "updated_fields": list(updates.keys())},
    )

    defaults = DEFAULT_PREFERENCES.model_dump()
    return PreferencesResponse(
        theme=current_prefs.get("theme", defaults["theme"]),
        default_model=current_prefs.get("default_model", defaults["default_model"]),
        hidden_personas=current_prefs.get(
            "hidden_personas", defaults["hidden_personas"]
        ),
    )


async def get_user_profile(db: AsyncSession, user_id: UUID) -> ProfileResponse:
    """Get user profile."""
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()

    if not user:
        raise ValueError(f"User {user_id} not found")

    return ProfileResponse(
        id=str(user.id),
        email=user.email,
        name=user.name,
        bio=user.bio,
        avatar_url=user.avatar_url,
        created_at=user.created_at.isoformat(),
    )


async def update_user_profile(
    db: AsyncSession, user_id: UUID, data: ProfileUpdateRequest
) -> ProfileResponse:
    """Update user profile."""
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()

    if not user:
        raise ValueError(f"User {user_id} not found")

    if data.name is not None:
        user.name = data.name
    if data.bio is not None:
        user.bio = data.bio

    await db.commit()
    await db.refresh(user)

    logger.info("user.profile.updated", extra={"user_id": str(user_id)})

    return ProfileResponse(
        id=str(user.id),
        email=user.email,
        name=user.name,
        bio=user.bio,
        avatar_url=user.avatar_url,
        created_at=user.created_at.isoformat(),
    )


async def get_user_stats(db: AsyncSession, user_id: UUID) -> UserStatsResponse:
    """Get user statistics."""
    # Get user for member_since
    user_result = await db.execute(select(User).where(User.id == user_id))
    user = user_result.scalar_one_or_none()

    if not user:
        raise ValueError(f"User {user_id} not found")

    # Count legacies owned by user
    legacies_result = await db.execute(
        select(func.count(Legacy.id)).where(Legacy.created_by == user_id)
    )
    legacies_count = legacies_result.scalar() or 0

    # Count stories across user's legacies
    stories_result = await db.execute(
        select(func.count(Story.id))
        .join(Legacy, Story.legacy_id == Legacy.id)
        .where(Legacy.created_by == user_id)
    )
    stories_count = stories_result.scalar() or 0

    # Count media items across user's legacies
    media_result = await db.execute(
        select(func.count(Media.id))
        .join(Legacy, Media.legacy_id == Legacy.id)
        .where(Legacy.created_by == user_id)
    )
    media_count = media_result.scalar() or 0

    # Calculate storage used (sum of media file sizes)
    storage_result = await db.execute(
        select(func.coalesce(func.sum(Media.file_size), 0))
        .join(Legacy, Media.legacy_id == Legacy.id)
        .where(Legacy.created_by == user_id)
    )
    storage_used = storage_result.scalar() or 0

    # Count unique collaborators (users who are members of user's legacies)
    collaborators_result = await db.execute(
        select(func.count(func.distinct(LegacyMember.user_id)))
        .join(Legacy, LegacyMember.legacy_id == Legacy.id)
        .where(Legacy.created_by == user_id)
        .where(LegacyMember.user_id != user_id)
    )
    collaborators_count = collaborators_result.scalar() or 0

    # TODO: Add chat_sessions_count when AI chat tracking is implemented
    # TODO: Add legacy_views_total when view tracking is implemented

    return UserStatsResponse(
        member_since=user.created_at,
        legacies_count=legacies_count,
        stories_count=stories_count,
        media_count=media_count,
        storage_used_bytes=storage_used,
        chat_sessions_count=0,  # Placeholder
        legacy_views_total=0,  # Placeholder
        collaborators_count=collaborators_count,
    )
```

**Step 2: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 3: Commit**

```bash
git add services/core-api/app/services/settings.py
git commit -m "feat(services): add user settings service"
```

---

### Task 9: Create Support Service

**Files:**
- Create: `services/core-api/app/services/support.py`

**Step 1: Create service file**

Create `services/core-api/app/services/support.py`:

```python
"""Service layer for support request operations."""

import logging
from uuid import UUID

from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from ..models.support_request import SupportRequest
from ..models.user import User
from ..schemas.support import SupportRequestCreate, SupportRequestResponse

logger = logging.getLogger(__name__)


async def create_support_request(
    db: AsyncSession,
    user_id: UUID,
    data: SupportRequestCreate,
) -> SupportRequestResponse:
    """Create a new support request and send email notification."""
    # Get user for email
    user_result = await db.execute(select(User).where(User.id == user_id))
    user = user_result.scalar_one_or_none()

    if not user:
        raise ValueError(f"User {user_id} not found")

    # Create support request record
    support_request = SupportRequest(
        user_id=user_id,
        category=data.category,
        subject=data.subject,
        message=data.message,
        context=data.context.model_dump(),
    )
    db.add(support_request)
    await db.commit()
    await db.refresh(support_request)

    logger.info(
        "support.request.created",
        extra={
            "support_request_id": str(support_request.id),
            "user_id": str(user_id),
            "category": data.category,
        },
    )

    # Send email notification (async, non-blocking)
    await _send_support_email(user, support_request, data)

    return SupportRequestResponse(
        id=support_request.id,
        category=support_request.category,
        subject=support_request.subject,
        status=support_request.status,
        created_at=support_request.created_at,
    )


async def _send_support_email(
    user: User,
    support_request: SupportRequest,
    data: SupportRequestCreate,
) -> None:
    """Send support request email notification.

    TODO: Integrate with AWS SES for production email sending.
    For now, just log the email content.
    """
    category_display = data.category.replace("_", " ").title()

    email_body = f"""
Subject: [{category_display}] {data.subject}

From: {user.email} (User ID: {user.id})
Category: {category_display}
Submitted: {support_request.created_at.isoformat()}

Message:
{data.message}

--- Context ---
Page: {data.context.page_url}
Legacy ID: {data.context.legacy_id or 'N/A'}
Browser: {data.context.user_agent}
Session Duration: {data.context.session_duration_seconds or 'N/A'} seconds
Errors: {', '.join(data.context.recent_errors) if data.context.recent_errors else 'None'}
"""

    logger.info(
        "support.email.would_send",
        extra={
            "to": "support@mosaiclife.me",
            "from_user": user.email,
            "subject": f"[{category_display}] {data.subject}",
            "body_preview": email_body[:500],
        },
    )

    # TODO: Replace with actual SES integration:
    # from ..adapters.email import send_email
    # await send_email(
    #     to="support@mosaiclife.me",
    #     subject=f"[{category_display}] {data.subject}",
    #     body=email_body,
    #     reply_to=user.email,
    # )
```

**Step 2: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 3: Commit**

```bash
git add services/core-api/app/services/support.py
git commit -m "feat(services): add support request service"
```

---

### Task 10: Create Settings Routes

**Files:**
- Create: `services/core-api/app/routes/settings.py`
- Modify: `services/core-api/app/main.py`

**Step 1: Create routes file**

Create `services/core-api/app/routes/settings.py`:

```python
"""Routes for user settings, preferences, and profile."""

from fastapi import APIRouter, Depends, HTTPException, Request
from sqlalchemy.ext.asyncio import AsyncSession

from ..auth.middleware import require_auth
from ..database import get_db
from ..schemas.preferences import (
    PreferencesResponse,
    PreferencesUpdateRequest,
    ProfileResponse,
    ProfileUpdateRequest,
)
from ..schemas.stats import UserStatsResponse
from ..services import settings as settings_service

router = APIRouter(prefix="/api/users/me", tags=["settings"])


@router.get("/preferences", response_model=PreferencesResponse)
async def get_preferences(
    request: Request,
    db: AsyncSession = Depends(get_db),
) -> PreferencesResponse:
    """Get current user's preferences."""
    session = require_auth(request)
    try:
        return await settings_service.get_user_preferences(db, session.user_id)
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))


@router.patch("/preferences", response_model=PreferencesResponse)
async def update_preferences(
    data: PreferencesUpdateRequest,
    request: Request,
    db: AsyncSession = Depends(get_db),
) -> PreferencesResponse:
    """Update current user's preferences."""
    session = require_auth(request)
    try:
        return await settings_service.update_user_preferences(
            db, session.user_id, data
        )
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))


@router.get("/profile", response_model=ProfileResponse)
async def get_profile(
    request: Request,
    db: AsyncSession = Depends(get_db),
) -> ProfileResponse:
    """Get current user's profile."""
    session = require_auth(request)
    try:
        return await settings_service.get_user_profile(db, session.user_id)
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))


@router.patch("/profile", response_model=ProfileResponse)
async def update_profile(
    data: ProfileUpdateRequest,
    request: Request,
    db: AsyncSession = Depends(get_db),
) -> ProfileResponse:
    """Update current user's profile."""
    session = require_auth(request)
    try:
        return await settings_service.update_user_profile(db, session.user_id, data)
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))


@router.get("/stats", response_model=UserStatsResponse)
async def get_stats(
    request: Request,
    db: AsyncSession = Depends(get_db),
) -> UserStatsResponse:
    """Get current user's usage statistics."""
    session = require_auth(request)
    try:
        return await settings_service.get_user_stats(db, session.user_id)
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))
```

**Step 2: Register router in main.py**

Add to `services/core-api/app/main.py` after other router imports:

```python
from .routes import settings as settings_routes

# Add after other router includes:
app.include_router(settings_routes.router)
```

**Step 3: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 4: Commit**

```bash
git add services/core-api/app/routes/settings.py services/core-api/app/main.py
git commit -m "feat(routes): add user settings endpoints"
```

---

### Task 11: Create Support Routes

**Files:**
- Create: `services/core-api/app/routes/support.py`
- Modify: `services/core-api/app/main.py`

**Step 1: Create routes file**

Create `services/core-api/app/routes/support.py`:

```python
"""Routes for support requests."""

from fastapi import APIRouter, Depends, HTTPException, Request
from sqlalchemy.ext.asyncio import AsyncSession

from ..auth.middleware import require_auth
from ..database import get_db
from ..schemas.support import SupportRequestCreate, SupportRequestResponse
from ..services import support as support_service

router = APIRouter(prefix="/api/support", tags=["support"])


@router.post("/request", response_model=SupportRequestResponse)
async def create_support_request(
    data: SupportRequestCreate,
    request: Request,
    db: AsyncSession = Depends(get_db),
) -> SupportRequestResponse:
    """Create a new support request.

    Captures user context and sends notification to support team.
    Rate limited to 5 requests per hour per user.
    """
    session = require_auth(request)

    # TODO: Add rate limiting check here

    try:
        return await support_service.create_support_request(
            db, session.user_id, data
        )
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
```

**Step 2: Register router in main.py**

Add to `services/core-api/app/main.py`:

```python
from .routes import support as support_routes

# Add after other router includes:
app.include_router(support_routes.router)
```

**Step 3: Validate**

Run: `cd services/core-api && just validate-backend`
Expected: PASS

**Step 4: Commit**

```bash
git add services/core-api/app/routes/support.py services/core-api/app/main.py
git commit -m "feat(routes): add support request endpoint"
```

---

## Phase 2: Frontend API Layer

### Task 12: Create Settings API Client

**Files:**
- Create: `apps/web/src/lib/api/settings.ts`

**Step 1: Create API client file**

Create `apps/web/src/lib/api/settings.ts`:

```typescript
/**
 * Settings API client for user preferences, profile, and stats.
 */

import { apiGet, apiPatch } from './client';

// Types
export interface UserPreferences {
  theme: string;
  default_model: string;
  hidden_personas: string[];
}

export interface PreferencesUpdateRequest {
  theme?: string;
  default_model?: string;
  hidden_personas?: string[];
}

export interface UserProfile {
  id: string;
  email: string;
  name: string;
  bio: string | null;
  avatar_url: string | null;
  created_at: string;
}

export interface ProfileUpdateRequest {
  name?: string;
  bio?: string;
}

export interface UserStats {
  member_since: string;
  legacies_count: number;
  stories_count: number;
  media_count: number;
  storage_used_bytes: number;
  chat_sessions_count: number;
  legacy_views_total: number;
  collaborators_count: number;
}

// API Functions
export async function getPreferences(): Promise<UserPreferences> {
  return apiGet<UserPreferences>('/api/users/me/preferences');
}

export async function updatePreferences(
  data: PreferencesUpdateRequest
): Promise<UserPreferences> {
  return apiPatch<UserPreferences>('/api/users/me/preferences', data);
}

export async function getProfile(): Promise<UserProfile> {
  return apiGet<UserProfile>('/api/users/me/profile');
}

export async function updateProfile(
  data: ProfileUpdateRequest
): Promise<UserProfile> {
  return apiPatch<UserProfile>('/api/users/me/profile', data);
}

export async function getStats(): Promise<UserStats> {
  return apiGet<UserStats>('/api/users/me/stats');
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/lib/api/settings.ts
git commit -m "feat(api): add settings API client"
```

---

### Task 13: Create Support API Client

**Files:**
- Create: `apps/web/src/lib/api/support.ts`

**Step 1: Create API client file**

Create `apps/web/src/lib/api/support.ts`:

```typescript
/**
 * Support API client for help requests.
 */

import { apiPost } from './client';

// Types
export interface SupportContext {
  page_url: string;
  timestamp: string;
  user_agent: string;
  legacy_id: string | null;
  session_duration_seconds: number | null;
  recent_errors: string[];
}

export interface SupportRequestCreate {
  category:
    | 'general_question'
    | 'bug_report'
    | 'feature_request'
    | 'account_issue'
    | 'other';
  subject: string;
  message: string;
  context: SupportContext;
}

export interface SupportRequestResponse {
  id: string;
  category: string;
  subject: string;
  status: string;
  created_at: string;
}

// API Functions
export async function createSupportRequest(
  data: SupportRequestCreate
): Promise<SupportRequestResponse> {
  return apiPost<SupportRequestResponse>('/api/support/request', data);
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/lib/api/support.ts
git commit -m "feat(api): add support API client"
```

---

### Task 14: Create Settings Hooks

**Files:**
- Create: `apps/web/src/lib/hooks/useSettings.ts`

**Step 1: Create hooks file**

Create `apps/web/src/lib/hooks/useSettings.ts`:

```typescript
/**
 * TanStack Query hooks for user settings.
 */

import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';

import {
  getPreferences,
  getProfile,
  getStats,
  PreferencesUpdateRequest,
  ProfileUpdateRequest,
  updatePreferences,
  updateProfile,
} from '../api/settings';

// Query keys factory
export const settingsKeys = {
  all: ['settings'] as const,
  preferences: () => [...settingsKeys.all, 'preferences'] as const,
  profile: () => [...settingsKeys.all, 'profile'] as const,
  stats: () => [...settingsKeys.all, 'stats'] as const,
};

// Preferences hooks
export function usePreferences() {
  return useQuery({
    queryKey: settingsKeys.preferences(),
    queryFn: getPreferences,
    staleTime: 1000 * 60 * 5, // 5 minutes
  });
}

export function useUpdatePreferences() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: PreferencesUpdateRequest) => updatePreferences(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: settingsKeys.preferences() });
    },
  });
}

// Profile hooks
export function useProfile() {
  return useQuery({
    queryKey: settingsKeys.profile(),
    queryFn: getProfile,
    staleTime: 1000 * 60 * 5, // 5 minutes
  });
}

export function useUpdateProfile() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: ProfileUpdateRequest) => updateProfile(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: settingsKeys.profile() });
    },
  });
}

// Stats hook
export function useStats() {
  return useQuery({
    queryKey: settingsKeys.stats(),
    queryFn: getStats,
    staleTime: 1000 * 60 * 10, // 10 minutes
  });
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/lib/hooks/useSettings.ts
git commit -m "feat(hooks): add settings hooks"
```

---

### Task 15: Create Support Hooks

**Files:**
- Create: `apps/web/src/lib/hooks/useSupport.ts`

**Step 1: Create hooks file**

Create `apps/web/src/lib/hooks/useSupport.ts`:

```typescript
/**
 * TanStack Query hooks for support requests.
 */

import { useMutation } from '@tanstack/react-query';

import {
  createSupportRequest,
  SupportRequestCreate,
} from '../api/support';

export function useCreateSupportRequest() {
  return useMutation({
    mutationFn: (data: SupportRequestCreate) => createSupportRequest(data),
  });
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/lib/hooks/useSupport.ts
git commit -m "feat(hooks): add support request hook"
```

---

## Phase 3: Frontend Settings Layout

### Task 16: Create Settings Layout Component

**Files:**
- Create: `apps/web/src/components/settings/SettingsLayout.tsx`

**Step 1: Create layout component**

Create `apps/web/src/components/settings/SettingsLayout.tsx`:

```typescript
/**
 * Settings page layout with sidebar navigation.
 */

import { ChevronLeft, Palette, Settings, User, BarChart3, Shield } from 'lucide-react';
import { NavLink, Outlet, useNavigate } from 'react-router-dom';

import { cn } from '@/lib/utils';

const sidebarItems = [
  { path: 'profile', label: 'Profile', icon: User },
  { path: 'appearance', label: 'Appearance', icon: Palette },
  { path: 'ai', label: 'AI Preferences', icon: Settings },
  { path: 'usage', label: 'Usage & Stats', icon: BarChart3 },
  { path: 'account', label: 'Account', icon: Shield },
];

export default function SettingsLayout() {
  const navigate = useNavigate();

  return (
    <div className="min-h-screen bg-[rgb(var(--theme-background))]">
      {/* Header */}
      <div className="border-b border-[rgb(var(--theme-primary))]/10 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
        <div className="max-w-6xl mx-auto px-4 py-4 flex items-center gap-4">
          <button
            onClick={() => navigate(-1)}
            className="flex items-center gap-1 text-sm text-gray-600 hover:text-gray-900 transition-colors"
          >
            <ChevronLeft className="size-4" />
            Back
          </button>
          <h1 className="text-xl font-semibold text-gray-900">Settings</h1>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-6">
        <div className="flex gap-8">
          {/* Sidebar */}
          <nav className="w-56 shrink-0">
            <ul className="space-y-1">
              {sidebarItems.map((item) => (
                <li key={item.path}>
                  <NavLink
                    to={item.path}
                    className={({ isActive }) =>
                      cn(
                        'flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors',
                        isActive
                          ? 'bg-[rgb(var(--theme-primary))]/10 text-[rgb(var(--theme-primary))]'
                          : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
                      )
                    }
                  >
                    <item.icon className="size-4" />
                    {item.label}
                  </NavLink>
                </li>
              ))}
            </ul>
          </nav>

          {/* Content */}
          <main className="flex-1 min-w-0">
            <Outlet />
          </main>
        </div>
      </div>
    </div>
  );
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/components/settings/SettingsLayout.tsx
git commit -m "feat(settings): add settings layout with sidebar"
```

---

### Task 17: Create Profile Settings Component

**Files:**
- Create: `apps/web/src/components/settings/ProfileSettings.tsx`

**Step 1: Create profile settings component**

Create `apps/web/src/components/settings/ProfileSettings.tsx`:

```typescript
/**
 * Profile settings section.
 */

import { useState } from 'react';

import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { useProfile, useUpdateProfile } from '@/lib/hooks/useSettings';

export default function ProfileSettings() {
  const { data: profile, isLoading } = useProfile();
  const updateProfile = useUpdateProfile();

  const [name, setName] = useState('');
  const [bio, setBio] = useState('');
  const [hasChanges, setHasChanges] = useState(false);

  // Initialize form when profile loads
  if (profile && !hasChanges && name === '' && bio === '') {
    setName(profile.name);
    setBio(profile.bio || '');
  }

  const handleNameChange = (value: string) => {
    setName(value);
    setHasChanges(value !== profile?.name || bio !== (profile?.bio || ''));
  };

  const handleBioChange = (value: string) => {
    setBio(value);
    setHasChanges(name !== profile?.name || value !== (profile?.bio || ''));
  };

  const handleSave = () => {
    updateProfile.mutate(
      { name, bio },
      {
        onSuccess: () => {
          setHasChanges(false);
        },
      }
    );
  };

  const handleCancel = () => {
    if (profile) {
      setName(profile.name);
      setBio(profile.bio || '');
      setHasChanges(false);
    }
  };

  if (isLoading) {
    return (
      <div className="animate-pulse space-y-4">
        <div className="h-8 bg-gray-200 rounded w-1/4"></div>
        <div className="h-24 bg-gray-200 rounded"></div>
      </div>
    );
  }

  const initials = profile?.name
    ?.split(' ')
    .map((n) => n[0])
    .join('')
    .toUpperCase()
    .slice(0, 2);

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-lg font-semibold text-gray-900">Profile</h2>
        <p className="text-sm text-gray-500">Manage your personal information</p>
      </div>

      {/* Avatar */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <Label className="text-sm font-medium text-gray-700">Avatar</Label>
        <div className="mt-2 flex items-center gap-4">
          <Avatar className="size-16">
            <AvatarImage src={profile?.avatar_url || undefined} />
            <AvatarFallback className="bg-[rgb(var(--theme-primary))]/10 text-[rgb(var(--theme-primary))] text-lg">
              {initials}
            </AvatarFallback>
          </Avatar>
          <div className="text-sm text-gray-500">
            Avatar is managed by your Google account
          </div>
        </div>
      </div>

      {/* Name */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <Label htmlFor="name" className="text-sm font-medium text-gray-700">
          Display Name
        </Label>
        <Input
          id="name"
          value={name}
          onChange={(e) => handleNameChange(e.target.value)}
          className="mt-2 max-w-md"
          maxLength={100}
        />
      </div>

      {/* Email */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <Label className="text-sm font-medium text-gray-700">Email</Label>
        <div className="mt-2 flex items-center gap-2">
          <Input
            value={profile?.email || ''}
            disabled
            className="max-w-md bg-gray-50"
          />
          <span className="text-xs text-green-600 font-medium">Verified</span>
        </div>
        <p className="mt-1 text-sm text-gray-500">
          Managed by Google - Connected via OAuth
        </p>
      </div>

      {/* Bio */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <Label htmlFor="bio" className="text-sm font-medium text-gray-700">
          Bio (optional)
        </Label>
        <Textarea
          id="bio"
          value={bio}
          onChange={(e) => handleBioChange(e.target.value)}
          placeholder="Tell others a bit about yourself..."
          className="mt-2 max-w-lg"
          maxLength={500}
          rows={4}
        />
        <p className="mt-1 text-sm text-gray-400">{bio.length}/500 characters</p>
      </div>

      {/* Actions */}
      <div className="flex justify-end gap-3">
        <Button
          variant="outline"
          onClick={handleCancel}
          disabled={!hasChanges || updateProfile.isPending}
        >
          Cancel
        </Button>
        <Button
          onClick={handleSave}
          disabled={!hasChanges || updateProfile.isPending}
        >
          {updateProfile.isPending ? 'Saving...' : 'Save Changes'}
        </Button>
      </div>
    </div>
  );
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/components/settings/ProfileSettings.tsx
git commit -m "feat(settings): add profile settings section"
```

---

### Task 18: Create Appearance Settings Component

**Files:**
- Create: `apps/web/src/components/settings/AppearanceSettings.tsx`

**Step 1: Create appearance settings component**

Create `apps/web/src/components/settings/AppearanceSettings.tsx`:

```typescript
/**
 * Appearance settings section with theme selection.
 */

import { Check } from 'lucide-react';

import { cn } from '@/lib/utils';
import { themes, ThemeCategory } from '@/lib/themes';
import { applyTheme } from '@/lib/themeUtils';
import { usePreferences, useUpdatePreferences } from '@/lib/hooks/useSettings';

const themesByCategory: Record<ThemeCategory, typeof themes> = {
  classic: themes.filter((t) => t.category === 'classic'),
  muted: themes.filter((t) => t.category === 'muted'),
  vibrant: themes.filter((t) => t.category === 'vibrant'),
};

const categoryLabels: Record<ThemeCategory, string> = {
  classic: 'Classic',
  muted: 'Muted',
  vibrant: 'Vibrant',
};

export default function AppearanceSettings() {
  const { data: preferences, isLoading } = usePreferences();
  const updatePreferences = useUpdatePreferences();

  const currentTheme = preferences?.theme || 'warm-amber';

  const handleThemeChange = (themeId: string) => {
    // Apply immediately for instant feedback
    applyTheme(themeId);
    localStorage.setItem('mosaic-theme', themeId);

    // Persist to backend
    updatePreferences.mutate({ theme: themeId });
  };

  if (isLoading) {
    return (
      <div className="animate-pulse space-y-4">
        <div className="h-8 bg-gray-200 rounded w-1/4"></div>
        <div className="h-48 bg-gray-200 rounded"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-lg font-semibold text-gray-900">Appearance</h2>
        <p className="text-sm text-gray-500">
          Customize how Mosaic Life looks for you
        </p>
      </div>

      <div className="bg-white rounded-lg border border-gray-200 p-6 space-y-6">
        <h3 className="text-sm font-medium text-gray-700">Theme</h3>

        {(Object.keys(themesByCategory) as ThemeCategory[]).map((category) => (
          <div key={category}>
            <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wider mb-3">
              {categoryLabels[category]}
            </h4>
            <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3">
              {themesByCategory[category].map((theme) => (
                <button
                  key={theme.id}
                  onClick={() => handleThemeChange(theme.id)}
                  className={cn(
                    'relative flex flex-col items-center p-3 rounded-lg border-2 transition-all',
                    currentTheme === theme.id
                      ? 'border-[rgb(var(--theme-primary))] bg-[rgb(var(--theme-primary))]/5'
                      : 'border-gray-200 hover:border-gray-300 bg-white'
                  )}
                >
                  {/* Color swatch */}
                  <div
                    className="w-10 h-10 rounded-full mb-2 shadow-sm"
                    style={{
                      background: `linear-gradient(135deg, rgb(${theme.colors.primary}) 0%, rgb(${theme.colors.accent}) 100%)`,
                    }}
                  />

                  {/* Theme name */}
                  <span className="text-xs font-medium text-gray-700 text-center">
                    {theme.name}
                  </span>

                  {/* Checkmark */}
                  {currentTheme === theme.id && (
                    <div className="absolute top-1 right-1 size-4 bg-[rgb(var(--theme-primary))] rounded-full flex items-center justify-center">
                      <Check className="size-3 text-white" />
                    </div>
                  )}
                </button>
              ))}
            </div>
          </div>
        ))}

        <p className="text-sm text-gray-500">
          Theme applies immediately and syncs to your account
        </p>
      </div>
    </div>
  );
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/components/settings/AppearanceSettings.tsx
git commit -m "feat(settings): add appearance settings with theme picker"
```

---

### Task 19: Create AI Preferences Settings Component

**Files:**
- Create: `apps/web/src/components/settings/AIPreferencesSettings.tsx`

**Step 1: Create AI preferences settings component**

Create `apps/web/src/components/settings/AIPreferencesSettings.tsx`:

```typescript
/**
 * AI Preferences settings section.
 */

import { useState, useEffect } from 'react';

import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { usePreferences, useUpdatePreferences } from '@/lib/hooks/useSettings';

const AI_MODELS = [
  {
    id: 'claude-opus-4.5',
    name: 'Claude Opus 4.5',
    description: 'Most capable - Deep reasoning and nuance',
  },
  {
    id: 'claude-sonnet-4.5',
    name: 'Claude Sonnet 4.5',
    description: 'Balanced - Great quality at faster speed',
  },
  {
    id: 'claude-haiku-4.5',
    name: 'Claude Haiku 4.5',
    description: 'Fast - Quick responses for simple tasks',
  },
  {
    id: 'deepseek-r1',
    name: 'DeepSeek-R1',
    description: 'Analytical - Strong reasoning and problem-solving',
  },
];

const AGENT_PERSONAS = [
  {
    id: 'biographer',
    name: 'Biographer',
    icon: 'ðŸ“–',
    description:
      'Helps document life events with historical context and narrative flow',
  },
  {
    id: 'friend',
    name: 'Friend',
    icon: 'ðŸ’¬',
    description:
      'Warm, conversational companion for sharing memories and stories',
  },
];

export default function AIPreferencesSettings() {
  const { data: preferences, isLoading } = usePreferences();
  const updatePreferences = useUpdatePreferences();

  const [defaultModel, setDefaultModel] = useState('claude-sonnet-4.5');
  const [hiddenPersonas, setHiddenPersonas] = useState<string[]>([]);
  const [hasChanges, setHasChanges] = useState(false);

  // Initialize from preferences
  useEffect(() => {
    if (preferences) {
      setDefaultModel(preferences.default_model);
      setHiddenPersonas(preferences.hidden_personas);
    }
  }, [preferences]);

  const handleModelChange = (model: string) => {
    setDefaultModel(model);
    setHasChanges(
      model !== preferences?.default_model ||
        JSON.stringify(hiddenPersonas) !==
          JSON.stringify(preferences?.hidden_personas)
    );
  };

  const handlePersonaToggle = (personaId: string, enabled: boolean) => {
    const newHidden = enabled
      ? hiddenPersonas.filter((id) => id !== personaId)
      : [...hiddenPersonas, personaId];

    setHiddenPersonas(newHidden);
    setHasChanges(
      defaultModel !== preferences?.default_model ||
        JSON.stringify(newHidden) !==
          JSON.stringify(preferences?.hidden_personas)
    );
  };

  const handleSave = () => {
    updatePreferences.mutate(
      { default_model: defaultModel, hidden_personas: hiddenPersonas },
      {
        onSuccess: () => {
          setHasChanges(false);
        },
      }
    );
  };

  const handleCancel = () => {
    if (preferences) {
      setDefaultModel(preferences.default_model);
      setHiddenPersonas(preferences.hidden_personas);
      setHasChanges(false);
    }
  };

  if (isLoading) {
    return (
      <div className="animate-pulse space-y-4">
        <div className="h-8 bg-gray-200 rounded w-1/4"></div>
        <div className="h-32 bg-gray-200 rounded"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-lg font-semibold text-gray-900">AI Preferences</h2>
        <p className="text-sm text-gray-500">Customize your AI experience</p>
      </div>

      {/* Default Model */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <Label className="text-sm font-medium text-gray-700">Default Model</Label>
        <p className="text-sm text-gray-500 mt-1 mb-3">
          Used when starting new chat sessions
        </p>

        <Select value={defaultModel} onValueChange={handleModelChange}>
          <SelectTrigger className="max-w-md">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {AI_MODELS.map((model) => (
              <SelectItem key={model.id} value={model.id}>
                <div className="flex flex-col">
                  <span className="font-medium">{model.name}</span>
                  <span className="text-xs text-gray-500">
                    {model.description}
                  </span>
                </div>
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Agent Personas */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <Label className="text-sm font-medium text-gray-700">Agent Personas</Label>
        <p className="text-sm text-gray-500 mt-1 mb-4">
          Choose which personas appear in your chat interface
        </p>

        <div className="space-y-3">
          {AGENT_PERSONAS.map((persona) => {
            const isEnabled = !hiddenPersonas.includes(persona.id);

            return (
              <div
                key={persona.id}
                className="flex items-center justify-between p-4 rounded-lg border border-gray-200"
              >
                <div className="flex items-center gap-3">
                  <span className="text-2xl">{persona.icon}</span>
                  <div>
                    <p className="font-medium text-gray-900">{persona.name}</p>
                    <p className="text-sm text-gray-500">{persona.description}</p>
                  </div>
                </div>
                <Switch
                  checked={isEnabled}
                  onCheckedChange={(checked) =>
                    handlePersonaToggle(persona.id, checked)
                  }
                />
              </div>
            );
          })}
        </div>

        <p className="text-sm text-gray-500 mt-4">
          Hidden personas won't appear in the chat persona picker
        </p>
      </div>

      {/* Actions */}
      <div className="flex justify-end gap-3">
        <Button
          variant="outline"
          onClick={handleCancel}
          disabled={!hasChanges || updatePreferences.isPending}
        >
          Cancel
        </Button>
        <Button
          onClick={handleSave}
          disabled={!hasChanges || updatePreferences.isPending}
        >
          {updatePreferences.isPending ? 'Saving...' : 'Save Changes'}
        </Button>
      </div>
    </div>
  );
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/components/settings/AIPreferencesSettings.tsx
git commit -m "feat(settings): add AI preferences settings"
```

---

### Task 20: Create Usage Stats Settings Component

**Files:**
- Create: `apps/web/src/components/settings/UsageStats.tsx`

**Step 1: Create usage stats component**

Create `apps/web/src/components/settings/UsageStats.tsx`:

```typescript
/**
 * Usage & Stats settings section.
 */

import { formatDistanceToNow } from 'date-fns';

import { useStats } from '@/lib/hooks/useSettings';

function formatBytes(bytes: number): string {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
}

interface StatCardProps {
  value: string | number;
  label: string;
}

function StatCard({ value, label }: StatCardProps) {
  return (
    <div className="bg-white rounded-lg border border-gray-200 p-4 text-center">
      <p className="text-2xl font-bold text-gray-900">{value}</p>
      <p className="text-sm text-gray-500">{label}</p>
    </div>
  );
}

export default function UsageStats() {
  const { data: stats, isLoading } = useStats();

  if (isLoading) {
    return (
      <div className="animate-pulse space-y-4">
        <div className="h-8 bg-gray-200 rounded w-1/4"></div>
        <div className="grid grid-cols-3 gap-4">
          <div className="h-24 bg-gray-200 rounded"></div>
          <div className="h-24 bg-gray-200 rounded"></div>
          <div className="h-24 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  if (!stats) {
    return (
      <div className="text-center py-8 text-gray-500">
        Unable to load statistics
      </div>
    );
  }

  const memberSince = new Date(stats.member_since);
  const memberSinceFormatted = memberSince.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
  const memberSinceRelative = formatDistanceToNow(memberSince, {
    addSuffix: true,
  });

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-lg font-semibold text-gray-900">Usage & Stats</h2>
        <p className="text-sm text-gray-500">Your activity on Mosaic Life</p>
      </div>

      {/* Member Since */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h3 className="text-sm font-medium text-gray-700">Member Since</h3>
        <p className="mt-1 text-gray-900">
          {memberSinceFormatted}{' '}
          <span className="text-gray-500">({memberSinceRelative})</span>
        </p>
      </div>

      {/* Content Stats */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h3 className="text-sm font-medium text-gray-700 mb-4">Content</h3>
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
          <StatCard value={stats.legacies_count} label="Legacies" />
          <StatCard value={stats.stories_count} label="Stories" />
          <StatCard value={stats.media_count} label="Media Items" />
          <StatCard
            value={formatBytes(stats.storage_used_bytes)}
            label="Storage Used"
          />
        </div>
      </div>

      {/* Engagement Stats */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h3 className="text-sm font-medium text-gray-700 mb-4">Engagement</h3>
        <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
          <StatCard value={stats.chat_sessions_count} label="Chat Sessions" />
          <StatCard value={stats.legacy_views_total} label="Legacy Views" />
          <StatCard value={stats.collaborators_count} label="Collaborators" />
        </div>
        <p className="mt-4 text-sm text-gray-500">
          Legacy Views shows total views across your public legacies.
          Collaborators counts unique contributors you've invited.
        </p>
      </div>
    </div>
  );
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/components/settings/UsageStats.tsx
git commit -m "feat(settings): add usage stats section"
```

---

### Task 21: Create Account Settings Component

**Files:**
- Create: `apps/web/src/components/settings/AccountSettings.tsx`

**Step 1: Create account settings component**

Create `apps/web/src/components/settings/AccountSettings.tsx`:

```typescript
/**
 * Account settings section.
 */

import { AlertTriangle, Download, LogOut } from 'lucide-react';
import { useState } from 'react';

import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useProfile } from '@/lib/hooks/useSettings';

export default function AccountSettings() {
  const { data: profile } = useProfile();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [deleteConfirmation, setDeleteConfirmation] = useState('');

  const handleExportData = () => {
    // TODO: Implement data export
    alert('Data export will be implemented in a future update.');
  };

  const handleDeleteAccount = () => {
    // TODO: Implement account deletion
    alert('Account deletion will be implemented in a future update.');
    setShowDeleteDialog(false);
    setDeleteConfirmation('');
  };

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-lg font-semibold text-gray-900">Account</h2>
        <p className="text-sm text-gray-500">
          Manage your account security and data
        </p>
      </div>

      {/* Connected Accounts */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h3 className="text-sm font-medium text-gray-700 mb-4">
          Connected Accounts
        </h3>
        <div className="flex items-center justify-between p-4 rounded-lg border border-gray-200">
          <div className="flex items-center gap-3">
            <div className="size-10 bg-blue-100 rounded-full flex items-center justify-center">
              <svg className="size-5" viewBox="0 0 24 24">
                <path
                  fill="#4285F4"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                />
                <path
                  fill="#34A853"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                />
                <path
                  fill="#FBBC05"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                />
                <path
                  fill="#EA4335"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                />
              </svg>
            </div>
            <div>
              <p className="font-medium text-gray-900">Google</p>
              <p className="text-sm text-gray-500">{profile?.email}</p>
            </div>
          </div>
          <span className="text-sm text-green-600 font-medium">Connected</span>
        </div>
        <p className="mt-3 text-sm text-gray-500">
          Primary sign-in method - Cannot be disconnected
        </p>
      </div>

      {/* Active Sessions - Placeholder */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h3 className="text-sm font-medium text-gray-700 mb-4">
          Active Sessions
        </h3>
        <div className="flex items-center justify-between p-4 rounded-lg border border-gray-200">
          <div className="flex items-center gap-3">
            <div className="size-10 bg-gray-100 rounded-full flex items-center justify-center">
              <LogOut className="size-5 text-gray-600" />
            </div>
            <div>
              <p className="font-medium text-gray-900">Current Session</p>
              <p className="text-sm text-gray-500">This browser</p>
            </div>
          </div>
          <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
            Active
          </span>
        </div>
        <p className="mt-3 text-sm text-gray-500">
          Session management will be available in a future update.
        </p>
      </div>

      {/* Export Data */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h3 className="text-sm font-medium text-gray-700 mb-2">
          Export Your Data
        </h3>
        <p className="text-sm text-gray-500 mb-4">
          Download a copy of your data including legacies, stories, media, and
          account information.
        </p>
        <Button variant="outline" onClick={handleExportData}>
          <Download className="size-4 mr-2" />
          Request Data Export
        </Button>
      </div>

      {/* Danger Zone */}
      <div className="bg-red-50 rounded-lg border border-red-200 p-6">
        <div className="flex items-start gap-3">
          <AlertTriangle className="size-5 text-red-600 shrink-0 mt-0.5" />
          <div className="flex-1">
            <h3 className="text-sm font-medium text-red-800">Delete Account</h3>
            <p className="text-sm text-red-600 mt-1">
              Permanently delete your account and all data. This action cannot be
              undone.
            </p>
            <Button
              variant="destructive"
              className="mt-4"
              onClick={() => setShowDeleteDialog(true)}
            >
              Delete Account
            </Button>
          </div>
        </div>
      </div>

      {/* Delete Confirmation Dialog */}
      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Are you absolutely sure?</AlertDialogTitle>
            <AlertDialogDescription>
              This action cannot be undone. This will permanently delete your
              account and remove all your data from our servers, including:
              <ul className="list-disc list-inside mt-2 space-y-1">
                <li>All legacies you've created</li>
                <li>All stories and media</li>
                <li>Your profile and preferences</li>
                <li>All AI chat history</li>
              </ul>
            </AlertDialogDescription>
          </AlertDialogHeader>
          <div className="my-4">
            <p className="text-sm text-gray-600 mb-2">
              Type <strong>DELETE</strong> to confirm:
            </p>
            <Input
              value={deleteConfirmation}
              onChange={(e) => setDeleteConfirmation(e.target.value)}
              placeholder="DELETE"
            />
          </div>
          <AlertDialogFooter>
            <AlertDialogCancel onClick={() => setDeleteConfirmation('')}>
              Cancel
            </AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDeleteAccount}
              disabled={deleteConfirmation !== 'DELETE'}
              className="bg-red-600 hover:bg-red-700"
            >
              Delete Account
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/components/settings/AccountSettings.tsx
git commit -m "feat(settings): add account settings section"
```

---

### Task 22: Create Settings Index Export

**Files:**
- Create: `apps/web/src/components/settings/index.ts`

**Step 1: Create index file**

Create `apps/web/src/components/settings/index.ts`:

```typescript
export { default as SettingsLayout } from './SettingsLayout';
export { default as ProfileSettings } from './ProfileSettings';
export { default as AppearanceSettings } from './AppearanceSettings';
export { default as AIPreferencesSettings } from './AIPreferencesSettings';
export { default as UsageStats } from './UsageStats';
export { default as AccountSettings } from './AccountSettings';
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/components/settings/index.ts
git commit -m "feat(settings): add settings barrel export"
```

---

### Task 23: Add Settings Routes

**Files:**
- Modify: `apps/web/src/routes/index.tsx`

**Step 1: Add lazy imports**

Add at the top of `apps/web/src/routes/index.tsx` with other lazy imports:

```typescript
// Settings components
const SettingsLayout = lazy(() => import('@/components/settings/SettingsLayout'));
const ProfileSettings = lazy(() => import('@/components/settings/ProfileSettings'));
const AppearanceSettings = lazy(() => import('@/components/settings/AppearanceSettings'));
const AIPreferencesSettings = lazy(() => import('@/components/settings/AIPreferencesSettings'));
const UsageStats = lazy(() => import('@/components/settings/UsageStats'));
const AccountSettings = lazy(() => import('@/components/settings/AccountSettings'));
```

**Step 2: Add settings routes**

Add inside the children array of the root route, after other protected routes:

```typescript
{
  path: 'settings',
  element: (
    <ProtectedRoute>
      <LazyPage>
        <SettingsLayout />
      </LazyPage>
    </ProtectedRoute>
  ),
  children: [
    {
      index: true,
      element: <Navigate to="profile" replace />,
    },
    {
      path: 'profile',
      element: <LazyPage><ProfileSettings /></LazyPage>,
    },
    {
      path: 'appearance',
      element: <LazyPage><AppearanceSettings /></LazyPage>,
    },
    {
      path: 'ai',
      element: <LazyPage><AIPreferencesSettings /></LazyPage>,
    },
    {
      path: 'usage',
      element: <LazyPage><UsageStats /></LazyPage>,
    },
    {
      path: 'account',
      element: <LazyPage><AccountSettings /></LazyPage>,
    },
  ],
},
```

**Step 3: Add Navigate import if not present**

Ensure `Navigate` is imported from 'react-router-dom'.

**Step 4: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 5: Commit**

```bash
git add apps/web/src/routes/index.tsx
git commit -m "feat(routes): add settings page routes"
```

---

## Phase 4: Help & Support Dialog

### Task 24: Create Help Support Dialog Component

**Files:**
- Create: `apps/web/src/components/HelpSupportDialog.tsx`

**Step 1: Create dialog component**

Create `apps/web/src/components/HelpSupportDialog.tsx`:

```typescript
/**
 * Help & Support dialog with context capture.
 */

import { Info } from 'lucide-react';
import { useState } from 'react';
import { useLocation, useParams } from 'react-router-dom';

import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { useCreateSupportRequest } from '@/lib/hooks/useSupport';
import { SupportRequestCreate } from '@/lib/api/support';

const CATEGORIES = [
  { value: 'general_question', label: 'General Question' },
  { value: 'bug_report', label: 'Bug Report' },
  { value: 'feature_request', label: 'Feature Request' },
  { value: 'account_issue', label: 'Account Issue' },
  { value: 'other', label: 'Other' },
] as const;

interface HelpSupportDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  sessionStartTime?: Date;
}

export default function HelpSupportDialog({
  open,
  onOpenChange,
  sessionStartTime,
}: HelpSupportDialogProps) {
  const location = useLocation();
  const params = useParams();
  const createSupportRequest = useCreateSupportRequest();

  const [category, setCategory] = useState<string>('');
  const [subject, setSubject] = useState('');
  const [message, setMessage] = useState('');
  const [showSuccess, setShowSuccess] = useState(false);

  const isValid = category && subject.trim() && message.trim();

  const handleSubmit = () => {
    if (!isValid) return;

    // Calculate session duration
    const sessionDuration = sessionStartTime
      ? Math.floor((Date.now() - sessionStartTime.getTime()) / 1000)
      : null;

    // Capture recent console errors (simplified)
    const recentErrors: string[] = [];

    const requestData: SupportRequestCreate = {
      category: category as SupportRequestCreate['category'],
      subject: subject.trim(),
      message: message.trim(),
      context: {
        page_url: location.pathname + location.search,
        timestamp: new Date().toISOString(),
        user_agent: navigator.userAgent,
        legacy_id: params.legacyId || null,
        session_duration_seconds: sessionDuration,
        recent_errors: recentErrors,
      },
    };

    createSupportRequest.mutate(requestData, {
      onSuccess: () => {
        setShowSuccess(true);
      },
    });
  };

  const handleClose = () => {
    setCategory('');
    setSubject('');
    setMessage('');
    setShowSuccess(false);
    onOpenChange(false);
  };

  if (showSuccess) {
    return (
      <Dialog open={open} onOpenChange={handleClose}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Request Submitted</DialogTitle>
            <DialogDescription>
              Thanks for reaching out! We'll respond to your email within 24-48
              hours.
            </DialogDescription>
          </DialogHeader>
          <DialogFooter>
            <Button onClick={handleClose}>Close</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    );
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-lg">
        <DialogHeader>
          <DialogTitle>Help & Support</DialogTitle>
          <DialogDescription>How can we help?</DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* Category */}
          <div className="space-y-2">
            <Label htmlFor="category">Category</Label>
            <Select value={category} onValueChange={setCategory}>
              <SelectTrigger id="category">
                <SelectValue placeholder="Select a category" />
              </SelectTrigger>
              <SelectContent>
                {CATEGORIES.map((cat) => (
                  <SelectItem key={cat.value} value={cat.value}>
                    {cat.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          {/* Subject */}
          <div className="space-y-2">
            <Label htmlFor="subject">Subject</Label>
            <Input
              id="subject"
              value={subject}
              onChange={(e) => setSubject(e.target.value)}
              placeholder="Brief description of your issue"
              maxLength={100}
            />
          </div>

          {/* Message */}
          <div className="space-y-2">
            <Label htmlFor="message">Message</Label>
            <Textarea
              id="message"
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              placeholder="Please describe your issue or question in detail..."
              maxLength={2000}
              rows={5}
            />
            <p className="text-xs text-gray-400 text-right">
              {message.length}/2000 characters
            </p>
          </div>

          {/* Context Info */}
          <div className="flex items-start gap-2 p-3 bg-blue-50 rounded-lg text-sm">
            <Info className="size-4 text-blue-600 shrink-0 mt-0.5" />
            <div className="text-blue-700">
              <p className="font-medium">We'll automatically include:</p>
              <ul className="mt-1 text-blue-600 space-y-0.5">
                <li>â€¢ Current page and legacy context</li>
                <li>â€¢ Browser and device info</li>
                <li>â€¢ Recent error logs (if any)</li>
              </ul>
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button
            onClick={handleSubmit}
            disabled={!isValid || createSupportRequest.isPending}
          >
            {createSupportRequest.isPending ? 'Sending...' : 'Send Message'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Step 2: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 3: Commit**

```bash
git add apps/web/src/components/HelpSupportDialog.tsx
git commit -m "feat(support): add help support dialog with context capture"
```

---

## Phase 5: Update Header Menu

### Task 25: Update HeaderUserMenu Component

**Files:**
- Modify: `apps/web/src/components/header/HeaderUserMenu.tsx`

**Step 1: Add state and dialog import**

Add imports at top:

```typescript
import { useState } from 'react';
import HelpSupportDialog from '@/components/HelpSupportDialog';
```

**Step 2: Add dialog state**

Inside the component, add:

```typescript
const [helpDialogOpen, setHelpDialogOpen] = useState(false);
```

**Step 3: Update menu items**

Remove the "My Profile" menu item. Update the "Settings" item to navigate to '/settings'. Update "Help & Support" to open the dialog:

Find and replace the menu items section to:

```typescript
{/* Navigation Items */}
<DropdownMenuItem onClick={() => navigate('/my-legacies')}>
  <BookOpen className="size-4 mr-3" />
  <span>My Legacies</span>
</DropdownMenuItem>

<DropdownMenuItem onClick={() => navigate('/settings')}>
  <Settings className="size-4 mr-3" />
  <span>Settings</span>
</DropdownMenuItem>

<DropdownMenuItem onClick={() => setHelpDialogOpen(true)}>
  <HelpCircle className="size-4 mr-3" />
  <span>Help & Support</span>
</DropdownMenuItem>
```

**Step 4: Add dialog component**

Add before the closing fragment or after DropdownMenu:

```typescript
<HelpSupportDialog
  open={helpDialogOpen}
  onOpenChange={setHelpDialogOpen}
/>
```

**Step 5: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 6: Commit**

```bash
git add apps/web/src/components/header/HeaderUserMenu.tsx
git commit -m "feat(header): update user menu with settings and help dialog"
```

---

## Phase 6: Theme Sync on Login

### Task 26: Sync Theme Preferences on Login

**Files:**
- Modify: `apps/web/src/routes/RootLayout.tsx`

**Step 1: Add preferences hook**

Add import:

```typescript
import { usePreferences } from '@/lib/hooks/useSettings';
```

**Step 2: Add effect to sync theme**

Inside the component, add after the existing theme loading logic:

```typescript
const { data: preferences } = usePreferences();

// Sync theme from backend on login
useEffect(() => {
  if (preferences?.theme) {
    setCurrentTheme(preferences.theme);
    localStorage.setItem('mosaic-theme', preferences.theme);
    applyTheme(preferences.theme);
  }
}, [preferences?.theme]);
```

**Step 3: Run lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 4: Commit**

```bash
git add apps/web/src/routes/RootLayout.tsx
git commit -m "feat(theme): sync theme preferences on login"
```

---

## Phase 7: Validation & Testing

### Task 27: Validate Backend

**Step 1: Run backend validation**

Run: `cd services/core-api && just validate-backend`
Expected: PASS with no errors

**Step 2: If errors, fix and re-run**

Address any mypy or ruff errors, then re-validate.

**Step 3: Commit any fixes**

```bash
git add -A
git commit -m "fix: address validation errors"
```

---

### Task 28: Validate Frontend

**Step 1: Run frontend lint**

Run: `cd apps/web && npm run lint`
Expected: PASS

**Step 2: Run frontend type check**

Run: `cd apps/web && npx tsc --noEmit`
Expected: PASS

**Step 3: Run frontend build**

Run: `cd apps/web && npm run build`
Expected: Build succeeds

**Step 4: Commit any fixes**

```bash
git add -A
git commit -m "fix: address frontend lint/type errors"
```

---

### Task 29: Manual Integration Test

**Step 1: Start services**

Run: `docker compose -f infra/compose/docker-compose.yml up -d`

**Step 2: Run migrations**

Run: `cd services/core-api && uv run alembic upgrade head`

**Step 3: Start frontend dev server**

Run: `cd apps/web && npm run dev`

**Step 4: Test Settings page**

1. Login with Google
2. Click profile dropdown
3. Verify "My Profile" is removed
4. Click "Settings" - should navigate to /settings/profile
5. Test each settings section
6. Verify theme changes sync

**Step 5: Test Help & Support**

1. Click "Help & Support" in dropdown
2. Verify dialog opens
3. Fill form and submit
4. Check backend logs for support request

**Step 6: Commit test notes**

Document any issues found and fix them.

---

## Summary

This implementation plan covers:

**Backend (Tasks 1-11):**
- Database migrations for user preferences, support requests, sessions
- SQLAlchemy models
- Pydantic schemas
- Service layer with business logic
- FastAPI routes

**Frontend API Layer (Tasks 12-15):**
- API clients for settings and support
- TanStack Query hooks

**Frontend Settings UI (Tasks 16-23):**
- Settings layout with sidebar
- Profile, Appearance, AI Preferences, Usage Stats, Account sections
- Route configuration

**Help & Support (Task 24):**
- Dialog component with context capture

**Integration (Tasks 25-26):**
- Updated header menu
- Theme sync on login

**Validation (Tasks 27-29):**
- Backend and frontend validation
- Integration testing

Total estimated tasks: 29
Each task should take 5-15 minutes.

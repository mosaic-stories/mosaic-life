# Mosaic Life - Simplified Local Development Stack
#
# Services: PostgreSQL + Backend API + Frontend Dev Server
# Startup time: <10 seconds
# Memory usage: ~300MB
#
# Quick start:
#   docker compose up -d
#   Frontend: http://localhost:5173 (Vite dev server with HMR)
#   Backend:  http://localhost:8080 (FastAPI with auto-reload)
#   API Docs: http://localhost:8080/docs
#   Postgres: localhost:15432

services:
  # Backend API (FastAPI)
  core-api:
    build:
      context: ../../services/core-api
      dockerfile: Dockerfile
    
    # Load environment variables from .env file
    env_file:
      - .env
    
    # Environment variables can be overridden here if needed
    # Uncomment and modify as necessary for specific deployments
    # environment:
    #   ENV: dev
    #   LOG_LEVEL: debug
    #   DB_URL: postgresql+psycopg://postgres:postgres@postgres:5432/mosaic
    #   GOOGLE_CLIENT_ID: your-client-id.apps.googleusercontent.com
    #   GOOGLE_CLIENT_SECRET: your-client-secret
    #   APP_URL: http://localhost:5173
    #   API_URL: http://localhost:8080
    #   SESSION_SECRET_KEY: dev-secret-key-change-in-production-use-openssl-rand-hex-32
    #   S3_MEDIA_BUCKET: mosaic-life-media-dev
    #   AWS_REGION: us-east-1

    ports:
      - "8080:8080"

    volumes:
      # Mount source code for hot reload (development only)
      - ../../services/core-api/app:/app/app:ro
      - ../../services/core-api/alembic:/app/alembic:ro
      - ../../services/core-api/tests:/app/tests:ro
      # Media storage volume for local development
      - media-data:/app/media
      # Mount AWS credentials for Bedrock access (uses host's STS credentials)
      - ~/.aws:/root/.aws:ro

    depends_on:
      postgres:
        condition: service_healthy

    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Frontend Dev Server (Vite with HMR)
  web:
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    
    # Load environment variables from .env file
    env_file:
      - .env
    
    # Environment variables can be overridden here if needed
    # Uncomment and modify as necessary for specific deployments
    # environment:
    #   VITE_API_URL: http://localhost:8080
    #   VITE_BACKEND_URL: http://core-api:8080
    
    ports:
      - "5173:5173"
    volumes:
      # Mount entire web app for hot reload
      - ../../apps/web:/app
      # Use named volume for node_modules (faster on non-Linux)
      - web-node-modules:/app/node_modules
    restart: unless-stopped

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine

    # Load environment variables from .env file
    env_file:
      - .env

    # Environment variables can be overridden here if needed
    # Uncomment and modify as necessary for specific deployments
    # environment:
    #   POSTGRES_USER: postgres
    #   POSTGRES_PASSWORD: postgres
    #   POSTGRES_DB: mosaic
    #   PGDATA: /var/lib/postgresql/data/pgdata

    ports:
      - "15432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d mosaic"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Documentation Site (MkDocs)
  docs:
    build:
      context: ../..
      dockerfile: apps/docs/Dockerfile
    ports:
      - "8000:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  # Prerender Service for SEO (renders pages for bots)
  prerender:
    image: prerender/prerender
    ports:
      - "3000:3000"
    environment:
      - CHROME_FLAGS=--no-sandbox --headless --disable-gpu --disable-dev-shm-usage
      - ALLOWED_DOMAINS=localhost,127.0.0.1
      - CACHE_MAXSIZE=1000
      - CACHE_TTL=86400
    mem_limit: 1g
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  postgres-data:
    driver: local
  web-node-modules:
    driver: local
  media-data:
    driver: local

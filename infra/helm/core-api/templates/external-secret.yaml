{{- if .Values.externalSecrets.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "core-api.fullname" . }}-db
  labels:
    {{- include "core-api.labels" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
spec:
  # Refresh secret every 5 minutes
  refreshInterval: 5m
  
  # Secret store reference (AWS Secrets Manager)
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStore }}
    kind: SecretStore
  
  # Target Kubernetes secret
  target:
    name: {{ include "core-api.fullname" . }}-db-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Construct DB_URL from fetched credentials and configured endpoint
        DB_URL: |
          postgresql+psycopg://{{`{{ .username }}`}}:{{`{{ .password }}`}}@{{ .Values.externalSecrets.dbEndpoint }}:{{ .Values.externalSecrets.dbPort }}/{{ .Values.externalSecrets.dbName }}
  
  # Data to fetch from AWS Secrets Manager (credentials only)
  dataFrom:
    - extract:
        key: {{ .Values.externalSecrets.credentialsSecretName }}

---
# SecretStore for AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ .Values.externalSecrets.secretStore }}
  labels:
    {{- include "core-api.labels" . | nindent 4 }}
  namespace: {{ .Release.Namespace }}
spec:
  provider:
    aws:
      service: SecretsManager
      region: {{ .Values.externalSecrets.region }}
      # Use IRSA for authentication (no static credentials)
      auth:
        jwt:
          serviceAccountRef:
            name: {{ include "core-api.serviceAccountName" . }}
{{- end }}
